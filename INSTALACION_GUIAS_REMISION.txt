# Instalación y Configuración - Guías de Remisión Electrónica

## Dependencias de Composer (Ya instaladas)

Las siguientes librerías ya están instaladas en el proyecto:

```bash
composer require greenter/greenter:^5.1
composer require greenter/gre-api:^1.0
composer require greenter/xmldsig:^5.0
```

### Versiones actuales:
- greenter/greenter: 5.1.2
- greenter/gre-api: 1.0.2
- greenter/xmldsig: 5.0.3

## Cambios en Base de Datos

### 1. Hacer campos nullable (EJECUTADO):

```sql
-- Cliente opcional
ALTER TABLE guias_remision MODIFY cliente_id bigint(20) unsigned NULL;
ALTER TABLE guias_remision MODIFY cliente_tipo_documento varchar(1) NULL;
ALTER TABLE guias_remision MODIFY cliente_numero_documento varchar(20) NULL;
ALTER TABLE guias_remision MODIFY cliente_razon_social varchar(200) NULL;
ALTER TABLE guias_remision MODIFY cliente_direccion varchar(200) NULL;

-- Destinatario opcional (para traslados internos)
ALTER TABLE guias_remision MODIFY destinatario_tipo_documento varchar(1) NULL;
ALTER TABLE guias_remision MODIFY destinatario_numero_documento varchar(20) NULL;
ALTER TABLE guias_remision MODIFY destinatario_razon_social varchar(200) NULL;
ALTER TABLE guias_remision MODIFY destinatario_direccion varchar(200) NULL;
ALTER TABLE guias_remision MODIFY destinatario_ubigeo varchar(6) NULL;

-- Actualizar foreign key para permitir NULL
ALTER TABLE guias_remision DROP FOREIGN KEY guias_remision_cliente_id_foreign;
ALTER TABLE guias_remision ADD CONSTRAINT guias_remision_cliente_id_foreign 
    FOREIGN KEY (cliente_id) REFERENCES clientes(id) ON DELETE SET NULL;
```

### 2. Verificar campos existentes:

La tabla debe tener estos campos (ya existen):
- tipo_guia (varchar 20)
- requiere_sunat (tinyint 1)
- venta_id (bigint unsigned NULL)
- comprobante_tipo (varchar 2 NULL)
- comprobante_serie (varchar 10 NULL)
- comprobante_numero (varchar 10 NULL)

## Archivos Creados/Modificados

### Backend:

1. **app/Models/GuiaRemision.php**
   - Agregado: serie, correlativo, tipo_comprobante, fecha_emision al $fillable
   - Solo 2 tipos: REMITENTE e INTERNO

2. **app/Http/Controllers/Facturacion/GuiasRemisionController.php**
   - cliente_id ahora es opcional
   - Validación mejorada según tipo de guía
   - Eliminado soporte para TRANSPORTISTA

3. **app/Services/GuiaRemisionService.php**
   - Corregidos métodos de Greenter:
     * setPesoBruto() → setPesoTotal()
     * setNumeroBultos() → setNumBultos()
     * Origin/Delivery → Direction con constructor
     * Transport → setChoferes(), setVehiculo()

4. **app/Console/Commands/TestGuiaRemision.php**
   - Comando de prueba para validar funcionalidad

### Documentación:

5. **docs/GUIA_RAPIDA_FRONTEND_GUIAS.md**
   - Guía completa para el frontend
   - Ejemplos de uso
   - Catálogos SUNAT

## Configuración Requerida

### 1. Serie para Guías de Remisión

Crear una serie activa en la tabla `series_comprobantes`:

```sql
INSERT INTO series_comprobantes (tipo_comprobante, serie, correlativo, activo, created_at, updated_at) 
VALUES ('09', 'T001', 1, 1, NOW(), NOW());
```

### 2. Variables de Entorno (.env)

Las mismas que para facturación electrónica:

```env
GREENTER_MODE=BETA  # o PRODUCCION
GREENTER_FE_USER=20000000001MODDATOS  # Usuario SOL
GREENTER_FE_PASSWORD=MODDATOS  # Contraseña SOL
GREENTER_CERT_PATH=certificates/certificate.pem  # Certificado digital
```

### 3. Endpoints SUNAT

**BETA (Pruebas):**
- Guías: https://e-beta.sunat.gob.pe/ol-ti-itemision-guia-gem-beta/billService?wsdl

**PRODUCCIÓN:**
- Guías: https://e-guiaremision.sunat.gob.pe/ol-ti-itemision-guia-gem/billService

## Pruebas

### Ejecutar tests:

```bash
# Probar GRE Remitente (con y sin cliente)
php artisan test:guia-remision --tipo=remitente

# Probar Traslado Interno
php artisan test:guia-remision --tipo=interno
```

### Verificar instalación de Greenter:

```bash
php check_greenter.php
```

## Tipos de Guías Soportados

### 1. GRE Remitente (REMITENTE)
- **Código SUNAT:** 09
- **Uso:** Ventas, envíos a clientes
- **Requiere SUNAT:** Sí
- **Cliente:** Opcional (puede ser destinatario manual con DNI)
- **Transporte:** Propio o contratado

### 2. Traslado Interno (INTERNO)
- **Código SUNAT:** 09 (no se envía)
- **Uso:** Movimientos entre almacenes propios
- **Requiere SUNAT:** No
- **Cliente:** No requerido
- **Transporte:** Interno

## Notas Importantes

1. **Cliente con RUC:** Solo requerido si usas "cliente como destinatario"
2. **Destinatario con DNI:** Permitido cuando se ingresa manualmente
3. **Conductor/Vehículo:** Solo requerido para transporte privado (modalidad '02')
4. **Peso y bultos:** Calculados automáticamente desde los productos
5. **Ubigeo:** Debe ser exactamente 6 dígitos (ej: 150101)

## Errores Comunes Resueltos

1. ✅ Field 'serie' doesn't have a default value
   - Solución: Agregado al $fillable del modelo

2. ✅ Field 'cliente_direccion' cannot be null
   - Solución: Campo hecho nullable en BD

3. ✅ Class "Greenter\Model\Despatch\Origin" not found
   - Solución: Usar Direction con constructor

4. ✅ Call to undefined method setPesoBruto()
   - Solución: Usar setPesoTotal() y setNumBultos()

## Soporte

Para más información sobre Greenter:
- Documentación: https://greenter.dev/
- GitHub: https://github.com/thegreenter/greenter
- Ejemplos: https://github.com/thegreenter/greenter/tree/master/examples
